pipeline {
    options {
        skipDefaultCheckout()
        timestamps()
    }
    agent {
        node { label 'internal-build.ncats' }
    }
    parameters {
        string(name: 'BUILD_VERSION', defaultValue: '', description: '')
        string(name: 'ENVIRONMENT', defaultValue: 'prod', description: 'Role Name (mandatory)')
    }
    environment {
        PROJECT_NAME = 'smartgraph'
        INIT_TOKEN   = credentials('Vault-Access')                                   // OIDC provider this token is Auto Generated //
        SPHINX_TOKEN = credentials('ncatssvcdvops-sphinx')                           // PatToken Read Only Access for the DevOps Artifacts Repo https://github.com/Sphinx-Automation/devops-pipeline-artifacts.git //
        NCATS_TOKEN = credentials('ncatssvcdvops-ncats')                             // PatToken Read Only Access for Settings Repo https://github.com/Sphinx-Automation/devops-pipeline-artifacts.git for facilities.json //
        ROLE_NAME    = "$ENVIRONMENT-$PROJECT_NAME"
        APP_TYPE     = "ui"
        ENVIRONMENT = 'prod'
        ENV = 'prod' 
    }
    stages {
        stage('cleanws'){
            steps {
                cleanWs()
            }
        }
        stage('Checkout code') {
            steps {
                checkout scm
            }
        }
        stage('deploy docker') {
            steps {
                // Passing Varibles prepare.sh to retrive NPMJS TOKEN & DOCKER AUTHENTICATION //
                configFileProvider(
                [configFile(fileId: 'aicp-smartgraph-ui-docker-compose-scb-prod.yml', targetLocation: 'docker-compose-scb.yml'),
                 configFile(fileId: 'prepare.sh', targetLocation: 'prepare.sh')]) {
                    withEnv([
                            "PROJECT_NAME=smartgraph",
                            "ENVIRONMENT=prod",
                            "ENV=prod",
                            "BUILD_VERSION=" + (params.BUILD_VERSION ?: env.BUILD_VERSION),                          
                            "ROLE_NAME=$ENV-$PROJECT_NAME",
                            "APP_TYPE=ui",
                            "DOCKER_REPO_NAME_1=ncats/smartgraph_frontend"
                            
                        ]) {
                    script {
                        sh '''#!/bin/bash
                        scp -r /home/deploy/jenkins/workspace/itrb-prod/smartgraph-scb-prod/smartgraph-scb-ui deploy@18.117.246.164:/home/deploy/jenkins/
                        ssh -i /home/deploy/jenkins/.ssh/id_rsa deploy@18.117.246.164 'chmod +x -R /home/deploy/jenkins/smartgraph-scb-ui/deploy.sh"
                        '''
                        sh '''#!/bin/bash
                        ssh -i /home/deploy/jenkins/.ssh/id_rsa deploy@18.117.246.164 '/home/deploy/jenkins/smartgraph-scb-ui/./deploy.sh'
                        '''
                        }
                    }
                }
            }
        }
    }
}
